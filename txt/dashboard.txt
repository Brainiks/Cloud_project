<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>–û–±–ª–∞–∫–æ ‚Äî Cloud Project</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            max-width: 1000px; 
            margin: 0 auto; 
            min-height: 100vh;
            /* –ó–∞–º–µ–Ω–∏ 'clouds.jpg' –Ω–∞ –ø—É—Ç—å –∫ —Ç–≤–æ–µ–º—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é */
            background-image: url('/frontend/clouds.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            position: relative;
        }
        
        /* –ü–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π –æ–≤–µ—Ä–ª–µ–π –¥–ª—è –ª—É—á—à–µ–π —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏ —Ç–µ–∫—Å—Ç–∞ */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.1); /* –ë–µ–ª—ã–π —Å –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å—é */
            z-index: -1;
        }
            
        h1 { 
            color: #ffffff; 
            margin-bottom: 5px;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }
        .upload-area {
            border: 2px dashed #4CAF50;
            padding: 30px;
            text-align: center;
            margin: 20px 0;
            cursor: pointer;
            background-color: #f9fff9;
            border-radius: 8px;
            transition: all 0.3s;
        }
        .upload-area:hover {
            border-color: #45a049;
            background-color: #f0fff0;
        }
        .upload-area.drag-over {
            border-color: #2196F3;
            background-color: #e8f4ff;
        }
        input[type="file"] { 
            display: none; 
        }
        button { 
            padding: 10px 16px; 
            border: none; 
            border-radius: 4px;
            cursor: pointer; 
            font-size: 14px;
            margin: 5px;
            transition: background-color 0.3s;
        }
        button.primary {
            background: #4CAF50; 
            color: white;
        }
        button.primary:hover {
            background: #45a049;
        }
        button.danger {
            background: #f44336;
            color: white;
        }
        button.danger:hover {
            background: #d32f2f;
        }
        button.secondary {
            background: #6c757d;
            color: white;
        }
        button.secondary:hover {
            background: #5a6268;
        }
        #status {
            margin: 10px 0;
            padding: 8px;
            border-radius: 4px;
        }
        .status-success {
            padding: 5px;
            border-radius: 5px;
            background-color: #dff0d8;
            color: #3c763d;
        }
        .status-error {
            background-color: #f2dede;
            color: #a94442;
        }
        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ñ–∞–π–ª–æ–≤ */
        .preview-container {
            margin: 20px 0;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .preview-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        .file-preview {
            display: flex;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }
        .file-preview:last-child {
            border-bottom: none;
        }
        .file-icon {
            width: 30px;
            height: 30px;
            background-color: #e0e0e0;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            flex-shrink: 0;
        }
        .file-info {
            flex-grow: 1;
        }
        .file-name {
            font-weight: 500;
            margin-bottom: 2px;
            word-break: break-all;
        }
        .file-size {
            color: #666;
            font-size: 12px;
        }
        .file-remove {
            background: none;
            border: none;
            color: #f44336;
            cursor: pointer;
            padding: 5px;
        }
        .file-remove:hover {
            background-color: #ffebee;
            border-radius: 50%;
        }
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã —Ñ–∞–π–ª–æ–≤ */
        #fileTableContainer {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-top: 20px;
            overflow: hidden;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f5f5f5;
            font-weight: 600;
        }
        tr:hover {
            background-color: #f9f9f9;
        }
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        #noFilesMessage {
            padding: 20px;
            text-align: center;
            color: #666;
        }
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
            }
            table {
                font-size: 14px;
            }
            th, td {
                padding: 8px 10px;
            }
        }
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –∑–∞–≥—Ä—É–∑–∫–∏ */
        #uploadProgressContainer {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .progress-container {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-bar {
            height: 24px;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            border-radius: 4px;
            position: relative;
            width: 0%;
            transition: width 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .progress-text {
            position: absolute;
            width: 100%;
            text-align: center;
            color: white;
            font-weight: bold;
            line-height: 24px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        
        .progress-details {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 14px;
            color: #666;
        }
        
        /* –ê–Ω–∏–º–∞—Ü–∏—è –ø—É–ª—å—Å–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ */
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
        
        .progress-bar.uploading {
            animation: pulse 1.5s infinite;
        }
        
        #progressTitle.upload-complete {
            color: #4CAF50;
            font-weight: bold;
        }
        
        #progressTitle.upload-error {
            color: #f44336;
        }
        /* –°—Ç–∏–ª–∏ –¥–ª—è —á–µ–∫–±–æ–∫—Å–æ–≤ –∏ –º–∞—Å—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π */
    .file-checkbox {
        display: inline-block;
        width: 18px;
        height: 18px;
        margin: 0;
        vertical-align: middle;
    }
    
    #selectAll {
        width: 18px;
        height: 18px;
        margin: 0;
        vertical-align: middle;
    }
    
    .selected-row {
        background-color: #e3f2fd !important;
    }
    
    #bulkActionsBar {
        display: none;
        transition: all 0.3s ease;
    }
    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
    @media (max-width: 768px) {
        #bulkActionsBar {
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
        }
        
        #bulkActionsBar div {
            float: none !important;
            width: 100%;
            margin-top: 10px;
        }
        
        #bulkActionsBar button {
            width: 100%;
        }
    }
    </style>
</head>
<body>
    <div class="header">
        <h1>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {{ username }}!</h1>
        <button class="secondary" onclick="syncFiles()" title="–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª—ã —Å –¥–∏—Å–∫–æ–º">
            <svg width="16" height="16" style="vertical-align: middle; margin-right: 5px;">
                <path d="M12 6v-2h-2L8 2 6 4H4v2l-2 2 2 2v2h2l2 2 2-2h2v-2l2-2-2-2zm-2 9.5L8 13l-2 2.5L3.5 13 6 10.5 3.5 8 6 5.5 8 8l2-2.5L12.5 8 10 10.5 12.5 13 10 15.5zM17 6v-1.5L18.5 6 21 3.5 18.5 1 17 2.5V1H7v2h10V6h2zm0 14v1.5l1.5-1.5L21 18.5 18.5 16 17 17.5V16H7v-2h10v2h2z" fill="currentColor"/>
            </svg>
            –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å
        </button>
        <button class="secondary" onclick="location.href='/logout'">–í—ã–π—Ç–∏</button>
    </div>

    <!-- –û–±–ª–∞—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ -->
    <div class="upload-area" id="dropZone">
        <p>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª—ã —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</p>
        <input type="file" id="fileInput" multiple>
        <button class="primary" onclick="document.getElementById('fileInput').click()">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª—ã</button>
    </div>

    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ -->
    <div class="preview-container" id="previewContainer" style="display: none;">
        <div class="preview-title">–í—ã–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏:</div>
        <div id="filePreviewList"></div>
        <div style="margin-top: 15px; text-align: right;">
            <button class="danger" onclick="clearSelectedFiles()">–û—á–∏—Å—Ç–∏—Ç—å –≤—ã–±–æ—Ä</button>
            <button class="primary" onclick="uploadFiles()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ</button>
        </div>
    </div>

    <div id="status"></div>


    <div id="uploadProgressContainer" style="display: none; margin: 20px 0;">
        <h3 id="progressTitle">–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤...</h3>
        <div class="progress-container">
            <div class="progress-bar" id="progressBar">
                <span class="progress-text" id="progressText">0%</span>
            </div>
        </div>
        <div class="progress-details">
            <span id="progressFiles">0 –∏–∑ 0 —Ñ–∞–π–ª–æ–≤</span>
            <span id="progressSpeed" style="float: right;">0 –ö–ë/—Å</span>
        </div>
    </div>


<!-- –ü–∞–Ω–µ–ª—å –º–∞—Å—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –Ω–∞–¥ —Ç–∞–±–ª–∏—Ü–µ–π -->
    <div id="bulkActionsBar" style="display: none;background: #e3f2fd; padding: 10px; border-radius: 4px; min-height: 46px; margin-bottom: 15px; border: 1px solid #bbdefb;">
        <span id="selectedCount">0 —Ñ–∞–π–ª–æ–≤ –≤—ã–±—Ä–∞–Ω–æ</span>
        <div style="float: right;">
            <button class="secondary" onclick="downloadSelectedFiles()">
                <svg width="16" height="16" style="vertical-align: middle; margin-right: 5px;">
                    <path d="M5 14h10v-2H5v2zm4-7h2V3h2l-3-3-3 3h2v4zm9 3H2v2h16v-2z" fill="currentColor"/>
                </svg>
                –°–∫–∞—á–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ
            </button>
            <button class="danger" onclick="deleteSelectedFiles()">
                <svg width="16" height="16" style="vertical-align: middle; margin-right: 5px;">
                    <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z" fill="currentColor"/>
                </svg>
                –£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ
            </button>
        </div>
    </div>


    <!-- –¢–∞–±–ª–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ -->
    <div id="fileTableContainer">
        <h2 style="padding: 15px; margin: 0; background-color: #f5f5f5; border-bottom: 1px solid #ddd;">–ú–æ–∏ —Ñ–∞–π–ª—ã</h2>
        <table id="fileTable">
            <thead>
                <tr>
                    <th style="width: 40px; padding: 12px 15px;">
                        <input type="checkbox" id="selectAll" title="–í—ã–±—Ä–∞—Ç—å –≤—Å–µ —Ñ–∞–π–ª—ã">
                    </th>
                    <th>–ò–º—è —Ñ–∞–π–ª–∞</th>
                    <th style="text-align: right;">–†–∞–∑–º–µ—Ä</th>
                    <th>–î–∞—Ç–∞ –∑–∞–≥—Ä—É–∑–∫–∏</th>
                    <th style="text-align: center;">–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody id="fileTableBody">
                <!-- –§–∞–π–ª—ã –±—É–¥—É—Ç –ø–æ–¥–≥—Ä—É–∂–∞—Ç—å—Å—è —Å—é–¥–∞ -->
            </tbody>
        </table>
        <p id="noFilesMessage" style="display: block; padding: 20px; text-align: center; color: #666;">
            –ù–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
        </p>
    </div>

    <script>
        // –î–æ–±–∞–≤—å —ç—Ç–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ –Ω–∞—á–∞–ª–æ —Å–∫—Ä–∏–ø—Ç–∞ (–ø–æ—Å–ª–µ let selectedFiles = [])
        let uploadStartTime = 0;
        let lastLoaded = 0;
        let lastTime = 0;
        let selectedFiles = [];

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
        document.addEventListener('DOMContentLoaded', function() {
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('fileInput');
            const previewContainer = document.getElementById('previewContainer');
            const filePreviewList = document.getElementById('filePreviewList');
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–æ–≤ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É
            fileInput.addEventListener('change', function(e) {
                handleFileSelect(e.target.files);
            });

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ drag & drop
            dropZone.addEventListener('dragover', function(e) {
                e.preventDefault();
                dropZone.classList.add('drag-over');
            });

            dropZone.addEventListener('dragleave', function() {
                dropZone.classList.remove('drag-over');
            });

            dropZone.addEventListener('drop', function(e) {
                e.preventDefault();
                dropZone.classList.remove('drag-over');
                handleFileSelect(e.dataTransfer.files);
            });

            // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            loadFileList();
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–æ–≤
        function handleFileSelect(files) {
            if (files.length === 0) return;
            
            selectedFiles = Array.from(files);
            updateFilePreview();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–≤—å—é –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
        function updateFilePreview() {
            const previewContainer = document.getElementById('previewContainer');
            const filePreviewList = document.getElementById('filePreviewList');
            
            if (selectedFiles.length === 0) {
                previewContainer.style.display = 'none';
                return;
            }
            
            previewContainer.style.display = 'block';
            filePreviewList.innerHTML = '';
            
            selectedFiles.forEach((file, index) => {
                const filePreview = document.createElement('div');
                filePreview.className = 'file-preview';
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–∫–æ–Ω–∫—É —Ñ–∞–π–ª–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
                let icon = 'üìÑ';
                if (file.type.startsWith('image/')) icon = 'üñºÔ∏è';
                if (file.type.startsWith('video/')) icon = 'üé¨';
                if (file.type.startsWith('audio/')) icon = 'üéµ';
                if (file.name.endsWith('.pdf')) icon = 'üìï';
                if (file.name.endsWith('.zip') || file.name.endsWith('.rar')) icon = 'üì¶';
                
                filePreview.innerHTML = `
                    <div class="file-icon">${icon}</div>
                    <div class="file-info">
                        <div class="file-name">${escapeHtml(file.name)}</div>
                        <div class="file-size">${formatBytes(file.size)}</div>
                    </div>
                    <button class="file-remove" onclick="removeFile(${index})" title="–£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª">√ó</button>
                `;
                
                filePreviewList.appendChild(filePreview);
            });
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö
        function removeFile(index) {
            selectedFiles.splice(index, 1);
            updateFilePreview();
        }

        // –û—á–∏—Å—Ç–∫–∞ —Å–ø–∏—Å–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
        function clearSelectedFiles() {
            selectedFiles = [];
            document.getElementById('fileInput').value = '';
            updateFilePreview();
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        function uploadFiles() {
            if (selectedFiles.length === 0) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª—ã –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏');
                return;
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º
            const progressContainer = document.getElementById('uploadProgressContainer');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const progressTitle = document.getElementById('progressTitle');
            const progressFiles = document.getElementById('progressFiles');
            const progressSpeed = document.getElementById('progressSpeed');
            const status = document.getElementById('status');
            
            progressContainer.style.display = 'block';
            progressTitle.textContent = '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –∑–∞–≥—Ä—É–∑–∫–µ...';
            progressTitle.className = '';
            progressBar.style.width = '0%';
            progressText.textContent = '0%';
            progressFiles.textContent = `0 –∏–∑ ${selectedFiles.length} —Ñ–∞–π–ª–æ–≤`;
            progressSpeed.textContent = '0 –ö–ë/—Å';
            progressBar.classList.remove('upload-complete', 'upload-error');
            progressBar.classList.add('uploading');
            
            status.innerHTML = '';
            status.className = '';

            // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç FormData
            const formData = new FormData();
            selectedFiles.forEach(file => {
                formData.append('files', file);
            });

            // –ò—Å–ø–æ–ª—å–∑—É–µ–º XMLHttpRequest –≤–º–µ—Å—Ç–æ fetch –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
            const xhr = new XMLHttpRequest();
            uploadStartTime = Date.now();
            lastTime = uploadStartTime;
            lastLoaded = 0;
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∑–∞–≥—Ä—É–∑–∫–∏
            xhr.upload.onprogress = function(event) {
                if (event.lengthComputable) {
                    const percentComplete = Math.round((event.loaded / event.total) * 100);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
                    progressBar.style.width = percentComplete + '%';
                    progressText.textContent = percentComplete + '%';
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–∫–æ—Ä–æ—Å—Ç–∏
                    const currentTime = Date.now();
                    const elapsedSeconds = (currentTime - lastTime) / 1000;
                    if (elapsedSeconds > 0.5) { // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑ –≤ 0.5 —Å–µ–∫—É–Ω–¥—ã
                        const bytesLoaded = event.loaded - lastLoaded;
                        const speedKBps = Math.round((bytesLoaded / elapsedSeconds) / 1024);
                        progressSpeed.textContent = formatSpeed(speedKBps);
                        
                        lastLoaded = event.loaded;
                        lastTime = currentTime;
                    }
                }
            };
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏
            xhr.onload = function() {
                progressBar.classList.remove('uploading');
                
                if (xhr.status >= 200 && xhr.status < 300) {
                    try {
                        const result = JSON.parse(xhr.responseText);
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –¥–æ 100%
                        progressBar.style.width = '100%';
                        progressText.textContent = '100%';
                        progressTitle.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!';
                        progressTitle.classList.add('upload-complete');
                        progressFiles.textContent = `${selectedFiles.length} –∏–∑ ${selectedFiles.length} —Ñ–∞–π–ª–æ–≤`;
                        
                        status.innerHTML = `<span class="status-success">${result.message}</span>`;
                        
                        // –û—á–∏—â–∞–µ–º –≤—ã–±–æ—Ä –∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
                        setTimeout(() => {
                            selectedFiles = [];
                            document.getElementById('fileInput').value = '';
                            updateFilePreview();
                            loadFileList();
                            
                            // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
                            setTimeout(() => {
                                progressContainer.style.display = 'none';
                            }, 2000);
                        }, 1000);
                        
                    } catch (e) {
                        handleError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                    }
                } else {
                    handleError(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${xhr.status}`);
                }
            };
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–∫–∏
            xhr.onerror = function() {
                handleError('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–æ–≤');
            };
            
            xhr.onabort = function() {
                handleError('–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞');
            };
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
            xhr.open('POST', '/upload', true);
            
            // –î–æ–±–∞–≤–ª—è–µ–º CSRF-—Ç–æ–∫–µ–Ω –µ—Å–ª–∏ –Ω—É–∂–µ–Ω (–¥–ª—è Flask)
            const csrfToken = document.querySelector('meta[name="csrf-token"]');
            if (csrfToken) {
                xhr.setRequestHeader('X-CSRFToken', csrfToken.content);
            }
            
            xhr.send(formData);
            
            // –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
            function handleError(message) {
                progressBar.classList.remove('uploading');
                progressBar.classList.add('upload-error');
                progressTitle.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏!';
                progressTitle.classList.add('upload-error');
                status.innerHTML = `<span class="status-error">${message}</span>`;
                
                console.error(message);
            }
            
            // –§—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–∫–æ—Ä–æ—Å—Ç–∏
            function formatSpeed(speedKBps) {
                if (speedKBps < 1024) {
                    return `${speedKBps} –ö–ë/—Å`;
                } else {
                    return `${(speedKBps / 1024).toFixed(1)} –ú–ë/—Å`;
                }
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤ —Å —Å–µ—Ä–≤–µ—Ä–∞
        async function loadFileList() {
            try {
                const response = await fetch('/files');
                if (!response.ok) {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª—ã');
                }
                const files = await response.json();

                const tbody = document.getElementById('fileTableBody');
                const noFilesMsg = document.getElementById('noFilesMessage');
                tbody.innerHTML = '';

                if (files.length === 0) {
                    noFilesMsg.style.display = 'block';
                    document.getElementById('bulkActionsBar').style.display = 'none';
                    return;
                }

                noFilesMsg.style.display = 'none';
                files.forEach(file => {
                    const row = document.createElement('tr');
                    row.dataset.filename = file.filename;
                    row.innerHTML = `
                        <td style="padding: 12px 15px;">
                            <input type="checkbox" class="file-checkbox" data-filename="${escapeHtml(file.filename)}">
                        </td>
                        <td>${escapeHtml(file.filename)}</td>
                        <td style="text-align: right;">${formatBytes(file.size)}</td>
                        <td>${new Date(file.uploaded_at).toLocaleString('ru-RU')}</td>
                        <td style="text-align: center;">
                            <div class="action-buttons">
                                <button class="secondary" onclick="downloadFile('${escapeHtml(file.filename)}')">–°–∫–∞—á–∞—Ç—å</button>
                                <button class="danger" onclick="deleteFile('${escapeHtml(file.filename)}')">–£–¥–∞–ª–∏—Ç—å</button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                // –ù–∞–≤–µ—à–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã
                setupCheckboxHandlers();
                
            } catch (err) {
                console.error(err);
                document.getElementById('status').innerHTML = 
                    `<span class="status-error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤: ${err.message}</span>`;
            }
        }

        // –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
        function downloadFile(filename) {
            window.location.href = `/download/${encodeURIComponent(filename)}`;
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞
        async function deleteFile(filename) {
            if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å "${filename}"?`)) {
                return;
            }

            try {
                const response = await fetch(`/delete/${encodeURIComponent(filename)}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                if (response.ok) {
                    alert('–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª—ë–Ω');
                    loadFileList(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (err) {
                console.error(err);
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + err.message);
            }
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 –ë';
            const k = 1024;
            const sizes = ['–ë', '–ö–ë', '–ú–ë', '–ì–ë'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }


        // 5. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —á–µ–∫–±–æ–∫—Å–æ–≤
    function setupCheckboxHandlers() {
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —á–µ–∫–±–æ–∫—Å–∞ "–í—ã–±—Ä–∞—Ç—å –≤—Å–µ"
        document.getElementById('selectAll').addEventListener('change', function(e) {
            const checkboxes = document.querySelectorAll('.file-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = e.target.checked;
                const row = cb.closest('tr');
                if (row) {
                    row.classList.toggle('selected-row', cb.checked);
                }
            });
            updateBulkActionsBar();
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —á–µ–∫–±–æ–∫—Å–æ–≤ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
        const checkboxes = document.querySelectorAll('.file-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const row = this.closest('tr');
                if (row) {
                    row.classList.toggle('selected-row', this.checked);
                }
                updateBulkActionsBar();
            });
        });
    }

    // 6. –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–∞–Ω–µ–ª–∏ –º–∞—Å—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
    function updateBulkActionsBar() {
        const checkedBoxes = document.querySelectorAll('.file-checkbox:checked');
        const count = checkedBoxes.length;
        const bulkActionsBar = document.getElementById('bulkActionsBar');
        const selectedCount = document.getElementById('selectedCount');
        
        bulkActionsBar.style.display = count > 0 ? 'block' : 'none';
        selectedCount.textContent = count === 1 ? '1 —Ñ–∞–π–ª –≤—ã–±—Ä–∞–Ω' : 
                                   count === 2 || count === 3 || count === 4 ? `${count} —Ñ–∞–π–ª–∞ –≤—ã–±—Ä–∞–Ω–æ` : 
                                   `${count} —Ñ–∞–π–ª–æ–≤ –≤—ã–±—Ä–∞–Ω–æ`;
    }

    // 7. –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–∞—Å—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
    async function downloadSelectedFiles() {
        const checkedBoxes = document.querySelectorAll('.file-checkbox:checked');
        if (checkedBoxes.length === 0) {
            alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ñ–∞–π–ª –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è');
            return;
        }
        
        if (!confirm(`–í—ã —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å —Å–∫–∞—á–∞—Ç—å ${checkedBoxes.length} —Ñ–∞–π–ª(–æ–≤) –≤ –æ–¥–Ω–æ–º –∞—Ä—Ö–∏–≤–µ. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?`)) {
            return;
        }

        const filenames = Array.from(checkedBoxes).map(cb => cb.dataset.filename);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        const bulkActionsBar = document.getElementById('bulkActionsBar');
        bulkActionsBar.innerHTML = `<div style="display: flex; align-items: center; justify-content: center; width: 100%;">
            <div class="progress-container" style="width: 200px; margin-right: 10px;">
                <div class="progress-bar" id="bulkProgressBar" style="width: 0%"></div>
            </div>
            <span id="bulkProgressText">–°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞...</span>
        </div>`;
        bulkActionsBar.style.display = 'block';

        try {
            const response = await fetch('/download-multiple', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ filenames: filenames })
            });

            if (response.ok) {
                // –°–∫–∞—á–∏–≤–∞–µ–º –∞—Ä—Ö–∏–≤
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'cloud_files.zip'; // –ò–º—è –±—É–¥–µ—Ç –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ —Å–µ—Ä–≤–µ—Ä–æ–º
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ
                document.querySelectorAll('.file-checkbox').forEach(cb => {
                    cb.checked = false;
                    const row = cb.closest('tr');
                    if (row) row.classList.remove('selected-row');
                });
                document.getElementById('selectAll').checked = false;
                updateBulkActionsBar();
                
                alert('–ê—Ä—Ö–∏–≤ —É—Å–ø–µ—à–Ω–æ —Å–∫–∞—á–∞–Ω!');
            } else {
                const errorData = await response.json();
                let errorMsg = errorData.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
                
                // –ï—Å–ª–∏ –µ—Å—Ç—å —Å–ø–∏—Å–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
                if (errorData.not_found && errorData.not_found.length > 0) {
                    errorMsg += `\n\n–§–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã: ${errorData.not_found.join(', ')}`;
                }
                
                alert('–û—à–∏–±–∫–∞: ' + errorMsg);
                bulkActionsBar.style.display = 'none';
            }
        } catch (err) {
            console.error(err);
            alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + err.message);
            bulkActionsBar.style.display = 'none';
        }
    }



    async function syncFiles() {
        if (!confirm('–í—ã–ø–æ–ª–Ω–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é —Ñ–∞–π–ª–æ–≤ —Å –¥–∏—Å–∫–æ–º?\n–≠—Ç–æ –¥–æ–±–∞–≤–∏—Ç –≤ –æ–±–ª–∞–∫–æ —Ñ–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ –ø—Ä–æ–≤–æ–¥–Ω–∏–∫.')) {
            return;
        }

        const status = document.getElementById('status');
        status.innerHTML = '<span class="status-success">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è... –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ.</span>';
        
        try {
            const response = await fetch('/sync', {
                method: 'POST'
            });

            const result = await response.json();
            
            if (response.ok) {
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤
                await loadFileList();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                let message = `–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!\n`;
                if (result.added > 0) {
                    message += `–î–æ–±–∞–≤–ª–µ–Ω–æ: ${result.added} —Ñ–∞–π–ª(–æ–≤)\n`;
                }
                if (result.removed > 0) {
                    message += `–£–¥–∞–ª–µ–Ω–æ: ${result.removed} –∑–∞–ø–∏—Å–µ–π (—Ñ–∞–π–ª–æ–≤ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)\n`;
                }
                if (result.added === 0 && result.removed === 0) {
                    message += `–ò–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ.`;
                }
                
                alert(message);
                status.innerHTML = `<span class="status-success">${message.replace(/\n/g, '<br>')}</span>`;
            } else {
                status.innerHTML = `<span class="status-error">–û—à–∏–±–∫–∞: ${result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}</span>`;
                alert('–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
        } catch (err) {
            status.innerHTML = `<span class="status-error">–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${err.message}</span>`;
            alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + err.message);
        }
    }

    async function deleteSelectedFiles() {
        const checkedBoxes = document.querySelectorAll('.file-checkbox:checked');
        if (checkedBoxes.length === 0) {
            alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ñ–∞–π–ª –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è');
            return;
        }
        
        if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å ${checkedBoxes.length} —Ñ–∞–π–ª(–æ–≤)?`)) {
            return;
        }

        const bulkActionsBar = document.getElementById('bulkActionsBar');
        bulkActionsBar.innerHTML = `<div style="display: flex; align-items: center; justify-content: center; width: 100%;">
            <div class="progress-container" style="width: 200px; margin-right: 10px;">
                <div class="progress-bar" id="bulkProgressBar" style="width: 0%"></div>
            </div>
            <span id="bulkProgressText">0/${checkedBoxes.length}</span>
        </div>`;
        bulkActionsBar.style.display = 'block';

        let successCount = 0;
        let errorCount = 0;

        for (let i = 0; i < checkedBoxes.length; i++) {
            const filename = checkedBoxes[i].dataset.filename;
            try {
                const response = await fetch(`/delete/${encodeURIComponent(filename)}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    successCount++;
                } else {
                    errorCount++;
                }
            } catch (err) {
                console.error(`–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞ ${filename}:`, err);
                errorCount++;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
            const progress = ((i + 1) / checkedBoxes.length) * 100;
            document.getElementById('bulkProgressBar').style.width = `${progress}%`;
            document.getElementById('bulkProgressText').textContent = `${i + 1}/${checkedBoxes.length}`;
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤
        await loadFileList();
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        alert(`${successCount} —Ñ–∞–π–ª(–æ–≤) —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–æ${errorCount > 0 ? `, ${errorCount} —Ñ–∞–π–ª(–æ–≤) –Ω–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å` : ''}`);
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π –≤–∏–¥ –ø–∞–Ω–µ–ª–∏ –º–∞—Å—Å–æ–≤—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π
        bulkActionsBar.innerHTML = `
            <span id="selectedCount">0 —Ñ–∞–π–ª–æ–≤ –≤—ã–±—Ä–∞–Ω–æ</span>
            <div style="float: right;">
                <button class="secondary" onclick="downloadSelectedFiles()">
                    <svg width="16" height="16" style="vertical-align: middle; margin-right: 5px;">
                        <path d="M5 14h10v-2H5v2zm4-7h2V3h2l-3-3-3 3h2v49 3H2v2h16v-2z" fill="currentColor"/>
                    </svg>
                    –°–∫–∞—á–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ
                </button>
                <button class="danger" onclick="deleteSelectedFiles()">
                    <svg width="16" height="16" style="vertical-align: middle; margin-right: 5px;">
                        <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z" fill="currentColor"/>
                    </svg>
                    –£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ
                </button>
            </div>
        `;
        
        // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ
        document.querySelectorAll('.file-checkbox').forEach(cb => {
            cb.checked = false;
            const row = cb.closest('tr');
            if (row) row.classList.remove('selected-row');
        });
        document.getElementById('selectAll').checked = false;
        updateBulkActionsBar();
    }

    </script>
</body>
</html>